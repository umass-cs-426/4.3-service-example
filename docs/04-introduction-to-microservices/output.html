<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>4.2-microservice-example</title>
  <style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}

ul.task-list[class]{list-style: none;}
ul.task-list li input[type="checkbox"] {
font-size: inherit;
width: 0.8em;
margin: 0 0.8em 0.2em -1.6em;
vertical-align: middle;
}
.display.math{display: block; text-align: center; margin: 0.5rem auto;}

pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
  <style type="text/css">
body {
font-family: 'Georgia', 'Times New Roman', serif;
font-size: 18px;
line-height: 1.8;
color: #333;
background-color: #FAFAFA;
margin: 0 auto;
padding: 40px;
max-width: 800px;
}

h1, h2, h3 {
font-family: 'Merriweather', serif;
color: #2c3e50;
margin-top: 30px;
}
h1 {
font-size: 2.2em;
border-bottom: 2px solid #d1d1d1;
padding-bottom: 5px;
}
h2 {
font-size: 1.8em;
margin-top: 25px;
}
h3 {
font-size: 1.5em;
margin-top: 20px;
}

p {
margin-bottom: 1.2em;
text-align: justify;
}

a {
color: #0077cc;
text-decoration: none;
}
a:hover {
text-decoration: underline;
}

blockquote {
font-style: italic;
color: #555;
border-left: 4px solid #0077cc;
padding-left: 15px;
margin: 20px 0;
background-color: #f5f5f5;
padding: 10px;
}

ul, ol {
margin-left: 20px;
padding-left: 20px;
}
li {
margin-bottom: 5px;
}

pre {
background: #f4f4f4;
padding: 10px;
border-radius: 5px;
overflow-x: auto;
font-family: 'Courier New', monospace;
font-size: 16px;
}

code {
background-color: #eee;
padding: 2px 5px;
border-radius: 4px;
font-family: 'Courier New', monospace;
}

table {
width: 100%;
border-collapse: collapse;
margin: 20px 0;
}
th, td {
border: 1px solid #ddd;
padding: 10px;
}
th {
background-color: #f1f1f1;
text-align: left;
}

img {
max-width: 100%;
display: block;
margin: 10px auto;
}

.note {
background: #e7f3ff;
padding: 10px;
border-left: 4px solid #0077cc;
font-style: italic;
margin: 20px 0;
}</style>
</head>
<body>
<h1 id="microservice-example">⚙️ Microservice Example</h1>
<h3 id="introduction">Introduction</h3>
<p>Microservices provide a modular and scalable approach to application
development by breaking down a system into independently deployable
services. In this example, we analyze a foundational TypeScript-based
microservice implemented using the Express framework step-by-step. This
microservice exposes several HTTP endpoints, including conventional
<code>/health</code> and <code>/metrics</code> endpoints, while adhering
to a functional programming paradigm. The code is structured using arrow
functions exclusively, avoiding the use of object-oriented patterns such
as classes. This design promotes immutability, composability, and a
declarative style of programming.</p>
<h3 id="project-creation-and-dependencies">Project Creation and
Dependencies</h3>
<p>It is always useful to start with a simple, yet clear example that we
can build on. We will be using TypeScript and the Express framework as
the major modules in this example. First, let us create a project folder
and install important modules:</p>
<pre><code>mkdir 4.1-basics-of-microservices
cd 4.1-basics-of-microservices
npm init -y
npm install -D typescript ts-node @types/express @types/node
npm install -S express performance</code></pre>
<p>We install the <code>typescript</code> and <code>ts-node</code>
modules as development dependencies. We do not need these modules after
we compile and build the application because the end result is simply
JavaScript. We also install <code>@types/express</code> and
<code>@types/node</code> as development dependencies as these modules
define the <em>types</em> that are used to type check your TypeScript
code in your code editor (e.g., VSCode) as well as when the TypeScript
compiler, <code>tsc</code>, is used to compile your code to JavaScript.
We then install <code>express</code> to make implementing the
microservice easier and the <code>performance</code> module to track
microservice metrics.</p>
<h3 id="setting-up-the-express-application">Setting Up the Express
Application</h3>
<p>The microservice begins by importing the necessary dependencies and
initializing an Express application. The Express framework is a
lightweight and flexible web server for Node.js, allowing for the
creation of HTTP endpoints with minimal boilerplate code. The
<code>performance</code> module from Node.js is also imported to
facilitate response time tracking, which is essential for monitoring the
service’s efficiency.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> express<span class="op">,</span> { Request<span class="op">,</span> Response } <span class="im">from</span> <span class="st">&quot;express&quot;</span><span class="op">;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { <span class="bu">performance</span> } <span class="im">from</span> <span class="st">&quot;perf_hooks&quot;</span><span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> app <span class="op">=</span> <span class="fu">express</span>()<span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> port <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">PORT</span> <span class="op">||</span> <span class="dv">3000</span><span class="op">;</span></span></code></pre></div>
<p>Here, the <code>express</code> module is imported along with the
<code>Request</code> and <code>Response</code> types, ensuring type
safety in our route handlers. The <code>app</code> constant represents
an instance of an Express application, and <code>port</code> is set to
either the value specified in the environment variable <code>PORT</code>
or defaults to <code>3000</code> if no such variable exists. This allows
the service to be configured dynamically based on its deployment
environment.</p>
<h3 id="middleware-for-request-logging"><strong>Middleware for Request
Logging</strong></h3>
<p>Logging HTTP requests is a fundamental practice in service monitoring
and debugging. The middleware function defined below logs the incoming
HTTP request method and URL, along with a timestamp.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> logger <span class="op">=</span> (req<span class="op">:</span> Request<span class="op">,</span> res<span class="op">:</span> Response<span class="op">,</span> next<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="kw">void</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`[</span><span class="sc">${</span><span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">toISOString</span>()<span class="sc">}</span><span class="vs">] </span><span class="sc">${</span>req<span class="op">.</span><span class="at">method</span><span class="sc">}</span><span class="vs"> </span><span class="sc">${</span>req<span class="op">.</span><span class="at">url</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">next</span>()<span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(logger)<span class="op">;</span></span></code></pre></div>
<p>This middleware function follows the Express middleware convention,
taking the request (<code>req</code>), response (<code>res</code>), and
a <code>next</code> function as arguments. The middleware executes
synchronously, printing the request details to the console before
invoking <code>next()</code>, which ensures that request processing
continues to subsequent middleware or route handlers. The
<code>app.use(logger);</code> statement registers this middleware
globally, meaning it will be executed for every incoming request.</p>
<h3 id="tracking-request-metrics"><strong>Tracking Request
Metrics</strong></h3>
<p>To monitor service performance, the microservice tracks the total
number of incoming requests and measures response times. Two global
variables are defined to store these metrics:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> requestCount <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> requestTimes<span class="op">:</span> number[] <span class="op">=</span> []<span class="op">;</span></span></code></pre></div>
<p>The <code>requestCount</code> variable maintains a count of the total
requests handled by the microservice, while <code>requestTimes</code>
stores the response duration of each request. To ensure these metrics
are updated correctly, a higher-order function is introduced that wraps
each route handler.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> recordMetrics <span class="op">=</span> (handler<span class="op">:</span> (req<span class="op">:</span> Request<span class="op">,</span> res<span class="op">:</span> Response) <span class="kw">=&gt;</span> <span class="kw">void</span>) <span class="kw">=&gt;</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  (req<span class="op">:</span> Request<span class="op">,</span> res<span class="op">:</span> Response) <span class="kw">=&gt;</span> {</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    requestCount<span class="op">++;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> start <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">on</span>(<span class="st">&quot;finish&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> requestTimes<span class="op">.</span><span class="fu">push</span>(<span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>() <span class="op">-</span> start))<span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">handler</span>(req<span class="op">,</span> res)<span class="op">;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span></code></pre></div>
<p>This function, <code>recordMetrics</code>, takes a standard route
handler as input and returns a new function that first increments the
request count and records the timestamp at the beginning of the request.
Once the response is finished, it calculates the total response duration
and appends it to the <code>requestTimes</code> array. This functional
approach enhances code modularity by allowing any route handler to be
wrapped in <code>recordMetrics</code>, ensuring that request statistics
are collected in a non-intrusive manner.</p>
<h3 id="health-check-endpoint"><strong>Health Check
Endpoint</strong></h3>
<p>A common feature of microservices is the implementation of a health
check endpoint, which allows external monitoring systems to verify that
the service is operational. The <code>/health</code> endpoint is defined
as follows:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&quot;/health&quot;</span><span class="op">,</span> <span class="fu">recordMetrics</span>((_<span class="op">,</span> res) <span class="kw">=&gt;</span> res<span class="op">.</span><span class="fu">json</span>({ <span class="dt">status</span><span class="op">:</span> <span class="st">&quot;healthy&quot;</span> })))<span class="op">;</span></span></code></pre></div>
<p>This route responds with a JSON object containing
<code>{ &quot;status&quot;: &quot;healthy&quot; }</code>. It is wrapped in the
<code>recordMetrics</code> function, ensuring that each request to this
endpoint contributes to the service’s performance metrics. This endpoint
is typically used by Kubernetes, load balancers, or monitoring tools to
determine whether the microservice is functioning as expected.</p>
<h3 id="metrics-endpoint"><strong>Metrics Endpoint</strong></h3>
<p>The <code>/metrics</code> endpoint provides quantitative insights
into the microservice’s behavior, including the total number of
processed requests and the average response time. The implementation is
as follows:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&quot;/metrics&quot;</span><span class="op">,</span> <span class="fu">recordMetrics</span>((_<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> avgResponseTime <span class="op">=</span> requestTimes<span class="op">.</span><span class="at">length</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">?</span> requestTimes<span class="op">.</span><span class="fu">reduce</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> a <span class="op">+</span> b<span class="op">,</span> <span class="dv">0</span>) <span class="op">/</span> requestTimes<span class="op">.</span><span class="at">length</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">set</span>(<span class="st">&quot;Content-Type&quot;</span><span class="op">,</span> <span class="st">&quot;text/plain&quot;</span>)<span class="op">;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">send</span>([</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="vs">`request_count </span><span class="sc">${</span>requestCount<span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="vs">`average_response_time_ms </span><span class="sc">${</span>avgResponseTime<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">`</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">.</span><span class="fu">join</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>))<span class="op">;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>}))<span class="op">;</span></span></code></pre></div>
<p>This endpoint computes the average response time by summing all
recorded response durations and dividing by the total number of
requests. If no requests have been processed, it defaults to
<code>0</code> to prevent division by zero. The response format follows
Prometheus conventions, returning plain-text key-value pairs that can be
easily parsed by monitoring systems.</p>
<h3 id="mock-endpoints-for-demonstration"><strong>Mock Endpoints for
Demonstration</strong></h3>
<p>To illustrate how additional endpoints can be integrated into the
microservice, two mock endpoints are provided.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&quot;/hello&quot;</span><span class="op">,</span> <span class="fu">recordMetrics</span>((_<span class="op">,</span> res) <span class="kw">=&gt;</span> res<span class="op">.</span><span class="fu">json</span>({ <span class="dt">message</span><span class="op">:</span> <span class="st">&quot;Hello, world!&quot;</span> })))<span class="op">;</span></span></code></pre></div>
<p>The <code>/hello</code> endpoint responds with a simple JSON object
containing <code>{ &quot;message&quot;: &quot;Hello, world!&quot; }</code>, demonstrating a
basic GET request. Similarly, a POST endpoint is included to echo back
received data:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">post</span>(<span class="st">&quot;/echo&quot;</span><span class="op">,</span> express<span class="op">.</span><span class="fu">json</span>()<span class="op">,</span> <span class="fu">recordMetrics</span>((req<span class="op">,</span> res) <span class="kw">=&gt;</span> res<span class="op">.</span><span class="fu">json</span>({ <span class="dt">received</span><span class="op">:</span> req<span class="op">.</span><span class="at">body</span> })))<span class="op">;</span></span></code></pre></div>
<p>This endpoint expects a JSON payload in the request body, which is
then returned as part of the response. The <code>express.json()</code>
middleware ensures that incoming JSON data is correctly parsed.</p>
<h3 id="starting-the-microservice"><strong>Starting the
Microservice</strong></h3>
<p>Finally, the Express application is started by binding it to the
specified port.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Microservice running on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">`</span>))<span class="op">;</span></span></code></pre></div>
<p>This function call initializes the HTTP server, allowing the
microservice to begin handling incoming requests. The provided callback
function logs a message indicating that the service is running, ensuring
visibility into the startup process.</p>
<h3 id="summary"><strong>Summary</strong></h3>
<p>This microservice demonstrates a structured approach to designing
HTTP-based services using TypeScript and Express. The inclusion of
<code>/health</code> and <code>/metrics</code> endpoints aligns with
modern microservice conventions, ensuring that the service remains
observable and maintainable. Additionally, the use of middleware and
request tracking mechanisms illustrates best practices for monitoring
performance and logging request activity. This foundational example
provides a template upon which more complex microservices can be built,
incorporating additional business logic, authentication mechanisms, and
inter-service communication patterns.</p>
<h3 id="complete-code"><strong>Complete Code</strong></h3>
<div class="sourceCode" id="cb11"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> express<span class="op">,</span> { Request<span class="op">,</span> Response } <span class="im">from</span> <span class="st">&quot;express&quot;</span><span class="op">;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { <span class="bu">performance</span> } <span class="im">from</span> <span class="st">&quot;perf_hooks&quot;</span><span class="op">;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> app <span class="op">=</span> <span class="fu">express</span>()<span class="op">;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> port <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">PORT</span> <span class="op">||</span> <span class="dv">3000</span><span class="op">;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Middleware for logging requests</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> logger <span class="op">=</span> (req<span class="op">:</span> Request<span class="op">,</span> res<span class="op">:</span> Response<span class="op">,</span> next<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="kw">void</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`[</span><span class="sc">${</span><span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">toISOString</span>()<span class="sc">}</span><span class="vs">] </span><span class="sc">${</span>req<span class="op">.</span><span class="at">method</span><span class="sc">}</span><span class="vs"> </span><span class="sc">${</span>req<span class="op">.</span><span class="at">url</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">next</span>()<span class="op">;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(logger)<span class="op">;</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Mock in-memory metrics</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> requestCount <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> requestTimes<span class="op">:</span> number[] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> recordMetrics <span class="op">=</span> (handler<span class="op">:</span> (req<span class="op">:</span> Request<span class="op">,</span> res<span class="op">:</span> Response) <span class="kw">=&gt;</span> <span class="kw">void</span>) <span class="kw">=&gt;</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    (req<span class="op">:</span> Request<span class="op">,</span> res<span class="op">:</span> Response) <span class="kw">=&gt;</span> {</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        requestCount<span class="op">++;</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> start <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>        res<span class="op">.</span><span class="fu">on</span>(<span class="st">&quot;finish&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> requestTimes<span class="op">.</span><span class="fu">push</span>(<span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>() <span class="op">-</span> start))<span class="op">;</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">handler</span>(req<span class="op">,</span> res)<span class="op">;</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="co">// Standard health check endpoint</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&quot;/health&quot;</span><span class="op">,</span> <span class="fu">recordMetrics</span>((_<span class="op">,</span> res) <span class="kw">=&gt;</span> res<span class="op">.</span><span class="fu">json</span>({ <span class="dt">status</span><span class="op">:</span> <span class="st">&quot;healthy&quot;</span> })))<span class="op">;</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Metrics endpoint (Prometheus-style)</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&quot;/metrics&quot;</span><span class="op">,</span> <span class="fu">recordMetrics</span>((_<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> avgResponseTime <span class="op">=</span> requestTimes<span class="op">.</span><span class="at">length</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">?</span> requestTimes<span class="op">.</span><span class="fu">reduce</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> a <span class="op">+</span> b<span class="op">,</span> <span class="dv">0</span>) <span class="op">/</span> requestTimes<span class="op">.</span><span class="at">length</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">set</span>(<span class="st">&quot;Content-Type&quot;</span><span class="op">,</span> <span class="st">&quot;text/plain&quot;</span>)<span class="op">;</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">send</span>([</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>        <span class="vs">`request_count </span><span class="sc">${</span>requestCount<span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>        <span class="vs">`average_response_time_ms </span><span class="sc">${</span>avgResponseTime<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">`</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">.</span><span class="fu">join</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>))<span class="op">;</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>}))<span class="op">;</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a><span class="co">// Example mock endpoint</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&quot;/hello&quot;</span><span class="op">,</span> <span class="fu">recordMetrics</span>((_<span class="op">,</span> res) <span class="kw">=&gt;</span> res<span class="op">.</span><span class="fu">json</span>({ <span class="dt">message</span><span class="op">:</span> <span class="st">&quot;Hello, world!&quot;</span> })))<span class="op">;</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a><span class="co">// Example POST endpoint</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">post</span>(<span class="st">&quot;/echo&quot;</span><span class="op">,</span> express<span class="op">.</span><span class="fu">json</span>()<span class="op">,</span> <span class="fu">recordMetrics</span>((req<span class="op">,</span> res) <span class="kw">=&gt;</span> res<span class="op">.</span><span class="fu">json</span>({ <span class="dt">received</span><span class="op">:</span> req<span class="op">.</span><span class="at">body</span> })))<span class="op">;</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a><span class="co">// Start the server</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Microservice running on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">`</span>))<span class="op">;</span></span></code></pre></div>
</body>
</html>
